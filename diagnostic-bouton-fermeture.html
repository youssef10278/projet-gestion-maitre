<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self'">
    <title>Diagnostic Bouton Fermeture</title>
    <link href="./src/css/output.css" rel="stylesheet">
    <style>
        .diagnostic-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 350px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            z-index: 2000;
            font-size: 12px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .status-ok { color: #059669; font-weight: bold; }
        .status-error { color: #dc2626; font-weight: bold; }
        .status-warning { color: #d97706; font-weight: bold; }
        .test-section { margin: 10px 0; padding: 8px; border-left: 3px solid #ccc; }
        .highlight-element { outline: 3px solid red !important; background: rgba(255,0,0,0.1) !important; }
    </style>
</head>
<body>
    <!-- Panel de diagnostic -->
    <div class="diagnostic-panel">
        <h3 style="margin: 0 0 15px 0; color: #333;">üîç Diagnostic Bouton Fermeture</h3>
        
        <div class="test-section">
            <strong>1. Structure HTML</strong>
            <div id="html-status">V√©rification...</div>
        </div>
        
        <div class="test-section">
            <strong>2. JavaScript</strong>
            <div id="js-status">V√©rification...</div>
        </div>
        
        <div class="test-section">
            <strong>3. CSS</strong>
            <div id="css-status">V√©rification...</div>
        </div>
        
        <div class="test-section">
            <strong>4. DOM</strong>
            <div id="dom-status">V√©rification...</div>
        </div>
        
        <div class="test-section">
            <strong>5. Actions</strong>
            <button onclick="forceCreateButton()" style="margin: 2px; padding: 4px 8px; font-size: 11px;">Forcer Cr√©ation</button>
            <button onclick="highlightSidebar()" style="margin: 2px; padding: 4px 8px; font-size: 11px;">Surligner Sidebar</button>
            <button onclick="showAllButtons()" style="margin: 2px; padding: 4px 8px; font-size: 11px;">Montrer Boutons</button>
            <button onclick="debugCSS()" style="margin: 2px; padding: 4px 8px; font-size: 11px;">Debug CSS</button>
        </div>
        
        <div class="test-section">
            <strong>6. Console</strong>
            <div id="mini-console" style="background: #f5f5f5; padding: 8px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 10px;"></div>
        </div>
    </div>

    <!-- Sidebar de test -->
    <aside class="w-64 bg-gray-800 text-white flex flex-col flex-shrink-0">
        <div class="p-4 text-xl font-bold border-b border-gray-700">
            üîç Test Sidebar
        </div>
        <nav class="flex-grow p-4">
            <a href="#" class="block py-3 px-4 rounded hover:bg-gray-700 mb-2 text-white no-underline">
                üè† Dashboard
            </a>
            <a href="#" class="block py-3 px-4 rounded hover:bg-gray-700 mb-2 text-white no-underline">
                üí∞ Caisse
            </a>
            <a href="#" class="block py-3 px-4 rounded hover:bg-gray-700 mb-2 text-white no-underline">
                üì¶ Produits
            </a>
        </nav>
    </aside>

    <!-- Contenu principal -->
    <main class="flex-1 p-8 ml-64">
        <h1 class="text-2xl font-bold mb-4">Diagnostic du Bouton de Fermeture</h1>
        <p>R√©duisez la largeur √† moins de 1024px pour activer le menu hamburger.</p>
        
        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <h3 class="font-bold">Instructions:</h3>
            <ol class="list-decimal list-inside mt-2 space-y-1">
                <li>R√©duisez la largeur du navigateur</li>
                <li>Cliquez sur le bouton hamburger</li>
                <li>V√©rifiez si le bouton X appara√Æt dans la sidebar</li>
                <li>Consultez le panel de diagnostic √† droite</li>
            </ol>
        </div>
    </main>

    <!-- Scripts -->
    <script src="./src/js/hamburger-menu.js"></script>
    
    <script>
        let diagnosticLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push(logEntry);
            
            const console = document.getElementById('mini-console');
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : '#374151';
            div.textContent = logEntry;
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
            
            // Limiter √† 20 entr√©es
            if (console.children.length > 20) {
                console.removeChild(console.firstChild);
            }
        }

        function runDiagnostic() {
            log('üîç D√©marrage diagnostic complet');
            
            // 1. V√©rifier la structure HTML
            checkHTMLStructure();
            
            // 2. V√©rifier JavaScript
            checkJavaScript();
            
            // 3. V√©rifier CSS
            checkCSS();
            
            // 4. V√©rifier DOM
            checkDOM();
            
            log('‚úÖ Diagnostic termin√©');
        }

        function checkHTMLStructure() {
            const sidebar = document.querySelector('aside');
            const htmlStatus = document.getElementById('html-status');
            
            if (sidebar) {
                htmlStatus.innerHTML = '<span class="status-ok">‚úÖ Sidebar trouv√©e</span>';
                log('‚úÖ Sidebar HTML trouv√©e');
                
                // V√©rifier la structure interne
                const header = sidebar.querySelector('.p-4');
                if (header) {
                    log('‚úÖ Header sidebar trouv√©');
                } else {
                    log('‚ö†Ô∏è Header sidebar non trouv√©', 'warning');
                }
                
                const nav = sidebar.querySelector('nav');
                if (nav) {
                    log('‚úÖ Navigation trouv√©e');
                } else {
                    log('‚ö†Ô∏è Navigation non trouv√©e', 'warning');
                }
                
            } else {
                htmlStatus.innerHTML = '<span class="status-error">‚ùå Sidebar non trouv√©e</span>';
                log('‚ùå Sidebar HTML non trouv√©e', 'error');
            }
        }

        function checkJavaScript() {
            const jsStatus = document.getElementById('js-status');
            let status = [];
            
            // V√©rifier la classe HamburgerMenu
            if (typeof HamburgerMenu !== 'undefined') {
                status.push('<span class="status-ok">‚úÖ Classe HamburgerMenu</span>');
                log('‚úÖ Classe HamburgerMenu disponible');
            } else {
                status.push('<span class="status-error">‚ùå Classe HamburgerMenu</span>');
                log('‚ùå Classe HamburgerMenu non disponible', 'error');
            }
            
            // V√©rifier l'instance
            if (window.hamburgerMenu) {
                status.push('<span class="status-ok">‚úÖ Instance cr√©√©e</span>');
                log('‚úÖ Instance window.hamburgerMenu cr√©√©e');
                
                // V√©rifier les propri√©t√©s
                if (window.hamburgerMenu.sidebar) {
                    status.push('<span class="status-ok">‚úÖ Sidebar r√©f√©renc√©e</span>');
                    log('‚úÖ Sidebar r√©f√©renc√©e dans l\'instance');
                } else {
                    status.push('<span class="status-error">‚ùå Sidebar non r√©f√©renc√©e</span>');
                    log('‚ùå Sidebar non r√©f√©renc√©e dans l\'instance', 'error');
                }
                
            } else {
                status.push('<span class="status-error">‚ùå Instance non cr√©√©e</span>');
                log('‚ùå Instance window.hamburgerMenu non cr√©√©e', 'error');
            }
            
            jsStatus.innerHTML = status.join('<br>');
        }

        function checkCSS() {
            const cssStatus = document.getElementById('css-status');
            let status = [];
            
            // V√©rifier si les styles sont charg√©s
            const testElement = document.createElement('div');
            testElement.className = 'sidebar-close-btn';
            testElement.style.position = 'absolute';
            testElement.style.left = '-9999px';
            document.body.appendChild(testElement);
            
            const computedStyle = window.getComputedStyle(testElement);
            
            if (computedStyle.position === 'absolute') {
                status.push('<span class="status-ok">‚úÖ CSS charg√©</span>');
                log('‚úÖ CSS de base charg√©');
            } else {
                status.push('<span class="status-error">‚ùå CSS non charg√©</span>');
                log('‚ùå CSS de base non charg√©', 'error');
            }
            
            // V√©rifier les styles sp√©cifiques du bouton
            const sidebarCloseBtn = document.querySelector('.sidebar-close-btn');
            if (sidebarCloseBtn) {
                const btnStyle = window.getComputedStyle(sidebarCloseBtn);
                status.push('<span class="status-ok">‚úÖ Bouton trouv√©</span>');
                log('‚úÖ Bouton .sidebar-close-btn trouv√© dans le DOM');
                
                // V√©rifier la visibilit√©
                if (btnStyle.display === 'none') {
                    status.push('<span class="status-warning">‚ö†Ô∏è Display: none</span>');
                    log('‚ö†Ô∏è Bouton masqu√© par display: none', 'warning');
                } else if (btnStyle.visibility === 'hidden') {
                    status.push('<span class="status-warning">‚ö†Ô∏è Visibility: hidden</span>');
                    log('‚ö†Ô∏è Bouton masqu√© par visibility: hidden', 'warning');
                } else if (btnStyle.opacity === '0') {
                    status.push('<span class="status-warning">‚ö†Ô∏è Opacity: 0</span>');
                    log('‚ö†Ô∏è Bouton masqu√© par opacity: 0', 'warning');
                } else {
                    status.push('<span class="status-ok">‚úÖ Bouton visible</span>');
                    log('‚úÖ Bouton devrait √™tre visible');
                }
                
                // V√©rifier la position
                log(`üìç Position: ${btnStyle.position}, Top: ${btnStyle.top}, Right: ${btnStyle.right}`);
                log(`üìè Taille: ${btnStyle.width} x ${btnStyle.height}`);
                log(`üé® Z-index: ${btnStyle.zIndex}`);
                
            } else {
                status.push('<span class="status-error">‚ùå Bouton non trouv√©</span>');
                log('‚ùå Bouton .sidebar-close-btn non trouv√© dans le DOM', 'error');
            }
            
            document.body.removeChild(testElement);
            cssStatus.innerHTML = status.join('<br>');
        }

        function checkDOM() {
            const domStatus = document.getElementById('dom-status');
            let status = [];
            
            // V√©rifier tous les boutons dans la sidebar
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                const allButtons = sidebar.querySelectorAll('button');
                status.push(`<span class="status-ok">üìä ${allButtons.length} bouton(s) trouv√©(s)</span>`);
                log(`üìä ${allButtons.length} bouton(s) trouv√©(s) dans la sidebar`);
                
                allButtons.forEach((btn, index) => {
                    log(`üîò Bouton ${index + 1}: classe="${btn.className}", id="${btn.id}"`);
                });
                
                // V√©rifier sp√©cifiquement le bouton de fermeture
                const closeBtn = sidebar.querySelector('.sidebar-close-btn');
                if (closeBtn) {
                    status.push('<span class="status-ok">‚úÖ Bouton fermeture trouv√©</span>');
                    log('‚úÖ Bouton de fermeture trouv√© dans la sidebar');
                    
                    // V√©rifier le parent
                    log(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent: ${closeBtn.parentElement.tagName}.${closeBtn.parentElement.className}`);
                    
                } else {
                    status.push('<span class="status-error">‚ùå Bouton fermeture manquant</span>');
                    log('‚ùå Bouton de fermeture manquant dans la sidebar', 'error');
                }
            }
            
            domStatus.innerHTML = status.join('<br>');
        }

        function forceCreateButton() {
            log('üîß Tentative de cr√©ation forc√©e du bouton');
            
            const sidebar = document.querySelector('aside');
            if (!sidebar) {
                log('‚ùå Impossible: sidebar non trouv√©e', 'error');
                return;
            }
            
            // Supprimer l'ancien bouton s'il existe
            const oldBtn = sidebar.querySelector('.sidebar-close-btn');
            if (oldBtn) {
                oldBtn.remove();
                log('üóëÔ∏è Ancien bouton supprim√©');
            }
            
            // Cr√©er un nouveau bouton
            const closeButton = document.createElement('button');
            closeButton.className = 'sidebar-close-btn touch-target';
            closeButton.setAttribute('aria-label', 'Fermer le menu');
            closeButton.style.cssText = `
                position: absolute !important;
                top: 12px !important;
                right: 12px !important;
                width: 32px !important;
                height: 32px !important;
                background: rgba(255, 255, 255, 0.2) !important;
                border: none !important;
                border-radius: 6px !important;
                color: white !important;
                cursor: pointer !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 1001 !important;
            `;
            closeButton.innerHTML = `
                <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            
            // Ajouter l'√©v√©nement
            closeButton.addEventListener('click', () => {
                if (window.hamburgerMenu) {
                    window.hamburgerMenu.closeMenu();
                    log('üîÑ Menu ferm√© via bouton forc√©');
                }
            });
            
            // Ins√©rer dans la sidebar
            const sidebarHeader = sidebar.querySelector('.p-4') || sidebar.firstElementChild;
            if (sidebarHeader) {
                sidebarHeader.style.position = 'relative';
                sidebarHeader.appendChild(closeButton);
                log('‚úÖ Bouton forc√© cr√©√© et ins√©r√©');
            } else {
                sidebar.appendChild(closeButton);
                log('‚úÖ Bouton forc√© cr√©√© (ajout√© √† la fin)');
            }
            
            // Relancer le diagnostic
            setTimeout(runDiagnostic, 100);
        }

        function highlightSidebar() {
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                sidebar.classList.add('highlight-element');
                log('üî¶ Sidebar surlign√©e');
                setTimeout(() => {
                    sidebar.classList.remove('highlight-element');
                }, 3000);
            }
        }

        function showAllButtons() {
            const allButtons = document.querySelectorAll('button');
            log(`üîò ${allButtons.length} bouton(s) total(s) sur la page:`);
            
            allButtons.forEach((btn, index) => {
                btn.style.outline = '2px solid red';
                log(`  ${index + 1}. ID: "${btn.id}", Classe: "${btn.className}"`);
                
                setTimeout(() => {
                    btn.style.outline = '';
                }, 3000);
            });
        }

        function debugCSS() {
            log('üé® Debug CSS approfondi');
            
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                const style = window.getComputedStyle(sidebar);
                log(`Sidebar - Position: ${style.position}, Z-index: ${style.zIndex}`);
                log(`Sidebar - Overflow: ${style.overflow}, Transform: ${style.transform}`);
            }
            
            // V√©rifier les media queries
            const isSmallScreen = window.matchMedia('(max-width: 1023px)').matches;
            log(`üì± √âcran petit (< 1024px): ${isSmallScreen}`);
            
            // V√©rifier les classes responsive
            if (sidebar) {
                log(`üè∑Ô∏è Classes sidebar: ${sidebar.className}`);
                log(`üì± Classe responsive: ${sidebar.classList.contains('sidebar-responsive')}`);
                log(`üì± Classe open: ${sidebar.classList.contains('sidebar-open')}`);
            }
        }

        // Initialisation
        window.addEventListener('load', () => {
            log('üöÄ Page charg√©e, d√©marrage diagnostic');
            setTimeout(runDiagnostic, 1000);
        });

        // Observer les changements
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1 && node.classList && node.classList.contains('sidebar-close-btn')) {
                            log('üëÄ Bouton de fermeture d√©tect√© (ajout√© au DOM)');
                            setTimeout(runDiagnostic, 100);
                        }
                    });
                }
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    </script>
</body>
</html>
