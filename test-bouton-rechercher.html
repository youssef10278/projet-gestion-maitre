<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bouton Rechercher - Historique</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .log-output {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <h1>ğŸ” Test du Bouton Rechercher - Historique des Retours</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ Instructions</h2>
        <ol>
            <li>Ouvrir l'application GestionPro</li>
            <li>Aller dans "Retours"</li>
            <li>Cliquer sur "Historique"</li>
            <li>Ouvrir cette page dans un nouvel onglet</li>
            <li>Utiliser les boutons de test ci-dessous</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª Tests Automatiques</h2>
        <button class="test-button" onclick="testModalExists()">1. VÃ©rifier Modal Existe</button>
        <button class="test-button" onclick="testButtonExists()">2. VÃ©rifier Bouton Existe</button>
        <button class="test-button" onclick="testEventAttached()">3. Tester Ã‰vÃ©nement</button>
        <button class="test-button" onclick="testDirectCall()">4. Appel Direct</button>
        <button class="test-button" onclick="testFullFlow()">5. Test Complet</button>
        <button class="test-button" onclick="clearLogs()">ğŸ§¹ Effacer Logs</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š RÃ©sultats des Tests</h2>
        <div id="status" class="status info">PrÃªt pour les tests...</div>
        <div id="logs" class="log-output">Logs des tests apparaÃ®tront ici...\n</div>
    </div>

    <div class="test-section">
        <h2>ğŸ› ï¸ Actions de Correction</h2>
        <button class="test-button" onclick="forceReconfigure()">Reconfigurer Ã‰vÃ©nements</button>
        <button class="test-button" onclick="simulateClick()">Simuler Clic</button>
        <button class="test-button" onclick="debugDOM()">Debug DOM</button>
    </div>

    <script>
        let logContainer = document.getElementById('logs');
        let statusContainer = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Mettre Ã  jour le statut
            statusContainer.textContent = message;
            statusContainer.className = `status ${type}`;
        }

        function clearLogs() {
            logContainer.textContent = 'Logs effacÃ©s...\n';
            statusContainer.textContent = 'Logs effacÃ©s';
            statusContainer.className = 'status info';
        }

        function testModalExists() {
            try {
                const modal = window.parent.document.getElementById('historyModal');
                if (modal) {
                    const isVisible = !modal.classList.contains('hidden');
                    log(`âœ… Modal trouvÃ©e - Visible: ${isVisible}`, 'success');
                    return true;
                } else {
                    log('âŒ Modal non trouvÃ©e', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Erreur accÃ¨s modal: ${error.message}`, 'error');
                return false;
            }
        }

        function testButtonExists() {
            try {
                const button = window.parent.document.getElementById('searchHistory');
                if (button) {
                    const isVisible = button.offsetParent !== null;
                    const isDisabled = button.disabled;
                    log(`âœ… Bouton trouvÃ© - Visible: ${isVisible}, Disabled: ${isDisabled}`, 'success');
                    return true;
                } else {
                    log('âŒ Bouton searchHistory non trouvÃ©', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Erreur accÃ¨s bouton: ${error.message}`, 'error');
                return false;
            }
        }

        function testEventAttached() {
            try {
                const button = window.parent.document.getElementById('searchHistory');
                if (!button) {
                    log('âŒ Bouton non trouvÃ© pour test Ã©vÃ©nement', 'error');
                    return false;
                }

                // CrÃ©er un Ã©vÃ©nement de test
                let eventFired = false;
                const testHandler = () => { eventFired = true; };
                
                button.addEventListener('click', testHandler);
                button.click();
                button.removeEventListener('click', testHandler);

                if (eventFired) {
                    log('âœ… Ã‰vÃ©nement click fonctionne', 'success');
                    return true;
                } else {
                    log('âŒ Ã‰vÃ©nement click ne fonctionne pas', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Erreur test Ã©vÃ©nement: ${error.message}`, 'error');
                return false;
            }
        }

        function testDirectCall() {
            try {
                if (window.parent.searchHistoryData) {
                    log('ğŸ” Appel direct de searchHistoryData...', 'info');
                    window.parent.searchHistoryData();
                    log('âœ… Fonction appelÃ©e directement', 'success');
                    return true;
                } else {
                    log('âŒ Fonction searchHistoryData non trouvÃ©e', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ Erreur appel direct: ${error.message}`, 'error');
                return false;
            }
        }

        function testFullFlow() {
            log('ğŸ§ª DÃ©but du test complet...', 'info');
            
            const tests = [
                { name: 'Modal existe', func: testModalExists },
                { name: 'Bouton existe', func: testButtonExists },
                { name: 'Ã‰vÃ©nement attachÃ©', func: testEventAttached },
                { name: 'Appel direct', func: testDirectCall }
            ];

            let passed = 0;
            tests.forEach(test => {
                if (test.func()) {
                    passed++;
                }
            });

            if (passed === tests.length) {
                log(`ğŸ‰ Tous les tests rÃ©ussis (${passed}/${tests.length})`, 'success');
            } else {
                log(`âš ï¸ ${passed}/${tests.length} tests rÃ©ussis`, 'warning');
            }
        }

        function forceReconfigure() {
            try {
                if (window.parent.forceSetupHistoryEvents) {
                    log('ğŸ”§ Reconfiguration forcÃ©e des Ã©vÃ©nements...', 'info');
                    window.parent.forceSetupHistoryEvents();
                    log('âœ… Reconfiguration terminÃ©e', 'success');
                } else {
                    log('âŒ Fonction forceSetupHistoryEvents non trouvÃ©e', 'error');
                }
            } catch (error) {
                log(`âŒ Erreur reconfiguration: ${error.message}`, 'error');
            }
        }

        function simulateClick() {
            try {
                if (window.parent.testHistorySearch) {
                    log('ğŸ–±ï¸ Simulation de clic...', 'info');
                    window.parent.testHistorySearch();
                    log('âœ… Simulation terminÃ©e', 'success');
                } else {
                    log('âŒ Fonction testHistorySearch non trouvÃ©e', 'error');
                }
            } catch (error) {
                log(`âŒ Erreur simulation: ${error.message}`, 'error');
            }
        }

        function debugDOM() {
            try {
                const modal = window.parent.document.getElementById('historyModal');
                if (modal) {
                    const elements = Array.from(modal.querySelectorAll('*[id]'));
                    log('ğŸ” Ã‰lÃ©ments avec ID dans la modal:', 'info');
                    elements.forEach(el => {
                        log(`  - ${el.id} (${el.tagName})`, 'info');
                    });
                } else {
                    log('âŒ Modal non trouvÃ©e pour debug', 'error');
                }
            } catch (error) {
                log(`âŒ Erreur debug DOM: ${error.message}`, 'error');
            }
        }

        // Auto-test au chargement
        setTimeout(() => {
            log('ğŸš€ Page de test chargÃ©e', 'info');
            log('ğŸ’¡ Ouvrez la modal historique dans l\'application puis utilisez les boutons de test', 'info');
        }, 1000);
    </script>
</body>
</html>
