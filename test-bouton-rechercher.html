<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bouton Rechercher - Historique</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .log-output {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <h1>üîç Test du Bouton Rechercher - Historique des Retours</h1>
    
    <div class="test-section">
        <h2>üìã Instructions</h2>
        <ol>
            <li>Ouvrir l'application GestionPro</li>
            <li>Aller dans "Retours"</li>
            <li>Cliquer sur "Historique"</li>
            <li>Ouvrir cette page dans un nouvel onglet</li>
            <li>Utiliser les boutons de test ci-dessous</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üß™ Tests Automatiques</h2>
        <button class="test-button" onclick="testModalExists()">1. V√©rifier Modal Existe</button>
        <button class="test-button" onclick="testButtonExists()">2. V√©rifier Bouton Existe</button>
        <button class="test-button" onclick="testEventAttached()">3. Tester √âv√©nement</button>
        <button class="test-button" onclick="testDirectCall()">4. Appel Direct</button>
        <button class="test-button" onclick="testFullFlow()">5. Test Complet</button>
        <button class="test-button" onclick="clearLogs()">üßπ Effacer Logs</button>
    </div>

    <div class="test-section">
        <h2>üìä R√©sultats des Tests</h2>
        <div id="status" class="status info">Pr√™t pour les tests...</div>
        <div id="logs" class="log-output">Logs des tests appara√Ætront ici...\n</div>
    </div>

    <div class="test-section">
        <h2>üõ†Ô∏è Actions de Correction</h2>
        <button class="test-button" onclick="forceReconfigure()">Reconfigurer √âv√©nements</button>
        <button class="test-button" onclick="simulateClick()">Simuler Clic</button>
        <button class="test-button" onclick="debugDOM()">Debug DOM</button>
    </div>

    <script>
        let logContainer = document.getElementById('logs');
        let statusContainer = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Mettre √† jour le statut
            statusContainer.textContent = message;
            statusContainer.className = `status ${type}`;
        }

        function clearLogs() {
            logContainer.textContent = 'Logs effac√©s...\n';
            statusContainer.textContent = 'Logs effac√©s';
            statusContainer.className = 'status info';
        }

        function testModalExists() {
            try {
                const modal = window.parent.document.getElementById('historyModal');
                if (modal) {
                    const isVisible = !modal.classList.contains('hidden');
                    log(`‚úÖ Modal trouv√©e - Visible: ${isVisible}`, 'success');
                    return true;
                } else {
                    log('‚ùå Modal non trouv√©e', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur acc√®s modal: ${error.message}`, 'error');
                return false;
            }
        }

        function testButtonExists() {
            try {
                const button = window.parent.document.getElementById('searchHistory');
                if (button) {
                    const isVisible = button.offsetParent !== null;
                    const isDisabled = button.disabled;
                    log(`‚úÖ Bouton trouv√© - Visible: ${isVisible}, Disabled: ${isDisabled}`, 'success');
                    return true;
                } else {
                    log('‚ùå Bouton searchHistory non trouv√©', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur acc√®s bouton: ${error.message}`, 'error');
                return false;
            }
        }

        function testEventAttached() {
            try {
                const button = window.parent.document.getElementById('searchHistory');
                if (!button) {
                    log('‚ùå Bouton non trouv√© pour test √©v√©nement', 'error');
                    return false;
                }

                // Cr√©er un √©v√©nement de test
                let eventFired = false;
                const testHandler = () => { eventFired = true; };
                
                button.addEventListener('click', testHandler);
                button.click();
                button.removeEventListener('click', testHandler);

                if (eventFired) {
                    log('‚úÖ √âv√©nement click fonctionne', 'success');
                    return true;
                } else {
                    log('‚ùå √âv√©nement click ne fonctionne pas', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur test √©v√©nement: ${error.message}`, 'error');
                return false;
            }
        }

        function testDirectCall() {
            try {
                if (window.parent.searchHistoryData) {
                    log('üîç Appel direct de searchHistoryData...', 'info');
                    window.parent.searchHistoryData();
                    log('‚úÖ Fonction appel√©e directement', 'success');
                    return true;
                } else {
                    log('‚ùå Fonction searchHistoryData non trouv√©e', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Erreur appel direct: ${error.message}`, 'error');
                return false;
            }
        }

        function testFullFlow() {
            log('üß™ D√©but du test complet...', 'info');
            
            const tests = [
                { name: 'Modal existe', func: testModalExists },
                { name: 'Bouton existe', func: testButtonExists },
                { name: '√âv√©nement attach√©', func: testEventAttached },
                { name: 'Appel direct', func: testDirectCall }
            ];

            let passed = 0;
            tests.forEach(test => {
                if (test.func()) {
                    passed++;
                }
            });

            if (passed === tests.length) {
                log(`üéâ Tous les tests r√©ussis (${passed}/${tests.length})`, 'success');
            } else {
                log(`‚ö†Ô∏è ${passed}/${tests.length} tests r√©ussis`, 'warning');
            }
        }

        function forceReconfigure() {
            try {
                if (window.parent.forceSetupHistoryEvents) {
                    log('üîß Reconfiguration forc√©e des √©v√©nements...', 'info');
                    window.parent.forceSetupHistoryEvents();
                    log('‚úÖ Reconfiguration termin√©e', 'success');
                } else {
                    log('‚ùå Fonction forceSetupHistoryEvents non trouv√©e', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur reconfiguration: ${error.message}`, 'error');
            }
        }

        function simulateClick() {
            try {
                if (window.parent.testHistorySearch) {
                    log('üñ±Ô∏è Simulation de clic...', 'info');
                    window.parent.testHistorySearch();
                    log('‚úÖ Simulation termin√©e', 'success');
                } else {
                    log('‚ùå Fonction testHistorySearch non trouv√©e', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur simulation: ${error.message}`, 'error');
            }
        }

        function debugDOM() {
            try {
                const modal = window.parent.document.getElementById('historyModal');
                if (modal) {
                    const elements = Array.from(modal.querySelectorAll('*[id]'));
                    log('üîç √âl√©ments avec ID dans la modal:', 'info');
                    elements.forEach(el => {
                        log(`  - ${el.id} (${el.tagName})`, 'info');
                    });
                } else {
                    log('‚ùå Modal non trouv√©e pour debug', 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur debug DOM: ${error.message}`, 'error');
            }
        }

        // Auto-test au chargement
        setTimeout(() => {
            log('üöÄ Page de test charg√©e', 'info');
            log('üí° Ouvrez la modal historique dans l\'application puis utilisez les boutons de test', 'info');
        }, 1000);
    </script>
</body>
</html>
